<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniSearch AI - Moteur de Recherche</title>
    <link rel="stylesheet" href="css-public.css"> 
</head>
<body>

    <div id="blocked-screen" class="overlay-screen" style="display: none;">
        <div class="overlay-icon">‚õî</div>
        <h2>Acc√®s Refus√©</h2>
        <p>Votre compte a √©t√© bloqu√© par un administrateur. Contactez le support pour plus d'informations.</p>
        <br>
        <a href="#" onclick="logout()" style="color:#4285f4;">Se D√©connecter</a>
    </div>

    <div id="maintenance-screen" class="overlay-screen" style="display: none;">
        <div class="overlay-icon">üöß</div>
        <h2>Site en Maintenance</h2>
        <p>Nous effectuons actuellement des mises √† jour importantes. Le service sera de retour tr√®s bient√¥t.</p>
        <br>
        <a href="login.html" style="color:#4285f4;">Acc√®s Admin</a>
    </div>

    <div id="main-content">
        <header style="display: flex; justify-content: flex-end; padding-top: 15px; padding-right: 15px;">
            <span id="user-info" style="margin-right: 20px;"></span>
            <a href="shop.html" class="admin-link" style="margin-right: 20px;">üéÅ Boutique & Giveaways</a>
            <a href="login.html" class="admin-link" id="login-link">Connexion</a> 
        </header>

        <main>
            <h1>OmniSearch AI üß†</h1>
            <p class="subtitle">Explorez les livres, les films et le savoir mondial gr√¢ce √† l'IA.</p>

            <nav class="mode-nav">
                <a href="index.html" style="background-color: #3498db; color: white;">Mode Standard</a>
                <a href="pro_mode.html">Mode Pro üíº</a>
                <a href="agent_mode.html">Mode Agent üïµÔ∏è</a>
                <a href="hosting_mode.html">Mode H√©bergement üåê</a> 
            </nav>

            <div class="search-container">
                <input type="text" id="query-input" placeholder="Posez votre question...">
                
                <select id="language-select">
                    <option value="fr" selected>FR</option>
                    <option value="en">EN</option>
                    <option value="es">ES</option>
                </select>

                <button class="search-btn" onclick="performGeneralAiSearch()" style="background-color: #2ecc71;">Rechercher (Groq)</button>
            </div>
            
            <div class="search-container" style="margin-top: 15px; max-width: 650px; background: #ecf0f1; height: 55px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <input type="text" id="site-ai-query-input" placeholder="Demander √† l'IA du Site (Aide, R√¥les, etc.)" style="border: none;">
                <button class="search-btn" onclick="performSiteAiSearch()" style="background-color: #e67e22; padding: 0 15px;">Demander au Site AI</button>
            </div>


            <div id="status-message" style="display: none; margin-top: 15px;"></div>

            <div id="results-area" style="margin-top: 20px;">
                <div id="loading-indicator" class="loading" style="display: none;">
                    L'IA r√©fl√©chit et r√©dige votre r√©ponse... ü§ñ
                </div>
                <div id="ai-response" class="ai-card" style="display: none;">
                    </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================
        // CONFIGURATION (DEUX CL√âS D'API GROQ)
        // ============================================
        
        // URL de l'API Groq (Commune aux deux IAs)
        const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";

        // 1. Configuration de l'IA de Recherche G√©n√©rale
        const GENERAL_AI_API_KEY = "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"; 
        const GENERAL_AI_MODEL = "llama-3.1-8b-instant"; 
        
        // 2. Configuration de l'IA du Site (Support)
        const SITE_AI_API_KEY = "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"; 
        const SITE_AI_MODEL = "whisper-large-v3-turbo"; // Un mod√®le plus puissant pour l'aide
        
        const STORAGE_MAINTENANCE_SITE = 'siteMaintenance';
        const STORAGE_MAINTENANCE_IA = 'iaMaintenance';
        const STORAGE_BLOCKED_USERS = 'blockedUsers';
        const STORAGE_CURRENT_USER = 'currentUser';
        const STORAGE_IS_LOGGED_IN = 'isLoggedIn';

        // ============================================
        // 1. V√âRIFICATION D'ACC√àS ET STATUT (Identique)
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            checkSystemStatus();
            updateLoginUI();
            
            // √âcouteur pour la recherche g√©n√©rale (touche Entr√©e)
            document.getElementById('query-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performGeneralAiSearch();
                }
            });

            // √âcouteur pour l'IA du site (touche Entr√©e)
            document.getElementById('site-ai-query-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performSiteAiSearch();
                }
            });
        });

        function updateLoginUI() {
            const isLoggedIn = localStorage.getItem(STORAGE_IS_LOGGED_IN) === 'true';
            const currentUser = localStorage.getItem(STORAGE_CURRENT_USER);
            const loginLink = document.getElementById('login-link');
            const userInfo = document.getElementById('user-info');
            
            if (isLoggedIn) {
                loginLink.textContent = "D√©connexion";
                loginLink.onclick = logout;
                loginLink.href = "#"; 
                userInfo.textContent = `Connect√©: ${currentUser} |`;
            } else {
                loginLink.textContent = "Connexion";
                loginLink.href = "login.html";
                loginLink.onclick = null;
                userInfo.textContent = "";
            }
        }

        function logout() {
            localStorage.removeItem(STORAGE_IS_LOGGED_IN);
            localStorage.removeItem(STORAGE_CURRENT_USER);
            localStorage.removeItem('currentUserType'); 
            window.location.href = 'index.html'; 
        }

        function checkSystemStatus() {
            const currentUser = localStorage.getItem(STORAGE_CURRENT_USER) || 'anonyme'; 
            const siteMaint = localStorage.getItem(STORAGE_MAINTENANCE_SITE) === 'true';
            const blockedUsers = JSON.parse(localStorage.getItem(STORAGE_BLOCKED_USERS) || '[]');
            
            const mainContent = document.getElementById('main-content');
            
            if (siteMaint) {
                document.getElementById('maintenance-screen').style.display = 'flex';
                mainContent.style.display = 'none';
                return; 
            }
            
            if (blockedUsers.includes(currentUser)) {
                document.getElementById('blocked-screen').style.display = 'flex';
                mainContent.style.display = 'none';
                return;
            }

            mainContent.style.display = 'block';
        }

        // ============================================
        // 2. FONCTION IA DE RECHERCHE G√âN√âRALE (GROQ)
        // ============================================
        async function performGeneralAiSearch() {
            const queryInput = document.getElementById('query-input');
            const query = queryInput.value.trim();
            const lang = document.getElementById('language-select').value;

            const systemPrompt = `Tu es un assistant expert en livres, films, culture et savoir g√©n√©ral. 
            R√©ponds √† la question de mani√®re structur√©e, claire et utile. 
            R√©ponds obligatoirement dans la langue : ${lang}.
            Si la question porte sur un livre, donne le titre, l'auteur, l'ann√©e et un r√©sum√©.`;
            
            await fetchAiResponse(GENERAL_AI_API_KEY, GENERAL_AI_MODEL, query, systemPrompt);
        }

        // ============================================
        // 3. FONCTION IA DU SITE (GROQ D√âDI√âE)
        // ============================================
        async function performSiteAiSearch() {
            const queryInput = document.getElementById('site-ai-query-input');
            const query = queryInput.value.trim();
            const lang = document.getElementById('language-select').value;

            // Prompt plus sp√©cifique aux r√®gles du site / fonctionnalit√©s
            const systemPrompt = `Tu es l'assistant de support du site OmniSearch. R√©ponds uniquement aux questions concernant la plateforme (r√®gles, modes, connexion, boutique, gestion des comptes). 
            Si la question n'est pas pertinente (ex: 'Qui a √©crit Harry Potter?'), r√©ponds poliment que tu ne peux pas aider et que l'utilisateur doit utiliser la fonction de Recherche G√©n√©rale (Groq). 
            R√©ponds obligatoirement dans la langue : ${lang}.`;
            
            await fetchAiResponse(SITE_AI_API_KEY, SITE_AI_MODEL, query, systemPrompt);
        }

        // ============================================
        // 4. FONCTION UTILITAIRE DE FETCH (R√©utilisable)
        // ============================================
        async function fetchAiResponse(apiKey, model, query, systemPrompt) {
            const resultsArea = document.getElementById('results-area');
            const loading = document.getElementById('loading-indicator');
            const responseDiv = document.getElementById('ai-response');
            const statusMsg = document.getElementById('status-message');

            statusMsg.style.display = 'none';
            responseDiv.style.display = 'none';
            responseDiv.textContent = '';
            
            if (!query) {
                alert("Veuillez √©crire quelque chose !");
                return;
            }

            const iaMaint = localStorage.getItem(STORAGE_MAINTENANCE_IA) === 'true';
            if (iaMaint) {
                statusMsg.textContent = "‚ö†Ô∏è La recherche IA est temporairement en maintenance. Revenez plus tard.";
                statusMsg.className = "error";
                statusMsg.style.display = 'block';
                return;
            }

            // V√©rification de la cl√©
            if (apiKey.includes("VOTRE_CLE_API_GROQ") || !apiKey) {
                 const keyName = apiKey === GENERAL_AI_API_KEY ? 'G√©n√©rale' : 'Site Support';
                 statusMsg.textContent = `Erreur Configuration : Cl√© API Groq (${keyName}) manquante. Veuillez ins√©rer votre cl√©.`;
                 statusMsg.className = "error";
                 statusMsg.style.display = 'block';
                 return;
            }

            resultsArea.style.display = 'block';
            loading.style.display = 'block';

            try {
                const response = await fetch(GROQ_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model, 
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: query }
                        ],
                        temperature: 0.7,
                        max_tokens: 1024
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const aiText = data.choices[0].message.content;
                loading.style.display = 'none';
                responseDiv.style.display = 'block';
                responseDiv.textContent = aiText;

            } catch (error) {
                loading.style.display = 'none';
                statusMsg.textContent = `Erreur IA : ${error.message}. V√©rifiez la cl√© API ou le nom du mod√®le Groq.`;
                statusMsg.className = "error";
                statusMsg.style.display = 'block';
                console.error(error);
            }
        }
    </script>
</body>
</html>
