<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniSearch AI - Interface de Chat IA</title>
    <link rel="stylesheet" href="css-public.css">
    </head>
<body>

    <div class="overlay-screen" id="maintenance-overlay" style="display:none;">
        <span class="overlay-icon">üöß</span>
        <h2>Maintenance du Site</h2>
        <p>Le site OmniSearch est actuellement en maintenance pour des am√©liorations. Veuillez revenir plus tard.</p>
        <a href="login.html">Connexion Administrateur</a>
    </div>

    <button class="mobile-sidebar-toggle" onclick="toggleSidebar()">‚ò∞ Menu Chats</button>

    <div id="app-container">
        
        <aside id="sidebar">
            <h2>Discussions (Chats)</h2>
            <button class="new-chat-btn" onclick="startNewChat()">+ Nouveau Chat</button>

            <ul id="chat-list">
                <li class="chat-item active" data-chat-id="1">Nouvelle session IA (Actif)</li>
                <li class="chat-item" data-chat-id="2">Id√©es de projet Python</li>
                <li class="chat-item" data-chat-id="3">Histoire de chat magique</li>
            </ul>

            <div id="sidebar-footer">
                <div id="user-info"></div>
                <a href="login.html" class="admin-link" id="admin-link">Connexion Admin</a>
            </div>
        </aside>

        <section id="main-chat-area">
            <h1>OmniSearch AI</h1>
            <p class="subtitle">Votre assistant intelligent unifi√© (Recherche, Code, Histoire).</p>

            <div id="response-container">
                
                <div id="ai-response-display">
                    <div id="ai-response" class="ai-card" style="display: none;">
                        Bienvenue ! Choisissez un mode ci-dessous et posez votre premi√®re question.
                    </div>
                    <div id="status-message" class="status-message" style="display:none;"></div>
                </div>

                <div class="input-mode-area">
                    <div class="mode-select-area">
                        <label for="mode-select-main">Mode IA :</label>
                        <select id="mode-select-main">
                            <option value="search">üåç Recherche G√©n√©rale</option>
                            <option value="code">üíª Agent Code</option>
                            <option value="story">üìö Conte d'Histoires</option>
                        </select>
                        
                        <label for="language-select-main">Langue :</label>
                        <select id="language-select-main">
                            <option value="fr">Fran√ßais</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <div class="search-input-group">
                        <input type="text" id="query-input-main" placeholder="Posez votre question...">
                        <button class="search-btn-main" onclick="performSearch()">Envoyer</button>
                    </div>
                </div>
            </div>

        </section>
    </div>
    
    <script>
        // ==========================================================
        //         CONFIGURATION ET CL√âS API GROQ
        // ==========================================================
        const GROQ_API_KEY_SEARCH = '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';
        const GROQ_API_KEY_CODE = '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';
        const GROQ_MODEL = 'llama-3.1-8b-instant';
        const GROQ_API_ENDPOINT = 'https://api.groq.com/openai/v1/chat/completions';

        // --- CONSTANTES DE STOCKAGE LOCAL ---
        const MAINTENANCE_SITE = 'siteMaintenance';
        const MAINTENANCE_IA = 'iaMaintenance';
        const BLOCKED_USERS = 'blockedUsers';
        const STORAGE_CURRENT_USER = 'currentUser';
        const STORAGE_IS_LOGGED_IN = 'isLoggedIn';

        // --- √âL√âMENTS DU DOM ---
        const sidebar = document.getElementById('sidebar');
        const queryInput = document.getElementById('query-input-main');
        const aiResponseDiv = document.getElementById('ai-response');
        const statusMessageDiv = document.getElementById('status-message');
        const searchButton = document.querySelector('.search-btn-main');
        const modeSelect = document.getElementById('mode-select-main');
        const languageSelect = document.getElementById('language-select-main');


        // ==========================================================
        //         LOGIQUE D'INITIALISATION ET DE S√âCURIT√â
        // ==========================================================

        document.addEventListener('DOMContentLoaded', () => {
            checkMaintenanceAndStatus();
            // Lier la touche Entr√©e au champ principal
            queryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            modeSelect.addEventListener('change', updatePlaceholder);
            updatePlaceholder(); 
        });

        // Toggle pour la sidebar sur mobile
        function toggleSidebar() {
            sidebar.style.display = sidebar.style.display === 'flex' ? 'none' : 'flex';
        }

        // Fonction pour simuler le d√©but d'un nouveau chat
        function startNewChat() {
            alert("Nouvelle session de chat d√©marr√©e (Impl√©mentation de l'historique n√©cessaire).");
            // En r√©alit√©, ici vous r√©initialiseriez l'affichage de la conversation
            aiResponseDiv.innerHTML = "Bienvenue ! Choisissez un mode ci-dessous et posez votre premi√®re question.";
            aiResponseDiv.style.display = 'block';
            statusMessageDiv.style.display = 'none';
        }

        function updatePlaceholder() {
            const mode = modeSelect.value;
            if (mode === 'code') {
                queryInput.placeholder = "Entrez votre probl√®me de code (langage, fonction, d√©bogage)...";
            } else if (mode === 'story') { 
                queryInput.placeholder = "D√©crivez les √©l√©ments de l'histoire que vous voulez inventer...";
            } else {
                queryInput.placeholder = "Posez votre question g√©n√©rale √† l'IA...";
            }
        }
        
        function displayStatusMessage(message, type = 'info') {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = ''; 
            statusMessageDiv.classList.add('status-message');
            if (type === 'error') {
                statusMessageDiv.classList.add('error');
            }
            statusMessageDiv.style.display = 'block';
        }
        
        // ... (checkMaintenanceAndStatus et logout restent inchang√©es) ...
        function checkMaintenanceAndStatus() {
            const siteMaintenance = localStorage.getItem(MAINTENANCE_SITE) === 'true';
            const iaMaintenance = localStorage.getItem(MAINTENANCE_IA) === 'true';
            const currentUser = localStorage.getItem(STORAGE_CURRENT_USER);
            const blockedUsers = JSON.parse(localStorage.getItem(BLOCKED_USERS) || '[]');
            
            if (siteMaintenance) {
                document.getElementById('maintenance-overlay').style.display = 'flex';
                return;
            }

            if (currentUser && blockedUsers.includes(currentUser)) {
                document.getElementById('maintenance-overlay').style.display = 'flex';
                document.querySelector('.overlay-icon').textContent = 'üö´';
                document.querySelector('.overlay-screen h2').textContent = 'Acc√®s Refus√©';
                document.querySelector('.overlay-screen p').textContent = 'Votre compte a √©t√© bloqu√© par un administrateur.';
                document.getElementById('admin-link').style.display = 'none';
                return;
            }

            if (iaMaintenance) {
                displayStatusMessage("L'IA est en maintenance. Le service est d√©sactiv√©.", 'error');
                searchButton.disabled = true;
                queryInput.disabled = true;
                modeSelect.disabled = true;
                languageSelect.disabled = true;
                queryInput.placeholder = "Service IA d√©sactiv√© (Maintenance)...";
            } else {
                searchButton.disabled = false;
                queryInput.disabled = false;
                modeSelect.disabled = false;
                languageSelect.disabled = false;
                updatePlaceholder();
            }
            
            const userInfoDiv = document.getElementById('user-info');
            const adminLink = document.getElementById('admin-link');
            if (currentUser) {
                userInfoDiv.innerHTML = `Connect√© : <strong>${currentUser}</strong>`;
                adminLink.textContent = "D√©connexion";
                adminLink.href = "#";
                adminLink.onclick = logout;
            } else {
                 userInfoDiv.innerHTML = `Invit√©`;
                 adminLink.textContent = "Connexion Admin";
                 adminLink.href = "login.html";
                 adminLink.onclick = null;
            }
        }
        
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentUserType');
            window.location.href = 'login.html';
        }


        // ==========================================================
        //         FONCTION DE RECHERCHE PRINCIPALE (IA)
        // ==========================================================

        async function performSearch() {
            const query = queryInput.value.trim();
            const language = languageSelect.value;
            const mode = modeSelect.value; 
            
            if (!query) {
                displayStatusMessage("Veuillez entrer une requ√™te.", 'error');
                return;
            }

            if (localStorage.getItem(MAINTENANCE_IA) === 'true') {
                 displayStatusMessage("Recherche impossible : L'IA est en maintenance.", 'error');
                 return;
            }
            
            // Affichage initial avant l'appel API
            displayStatusMessage(`Recherche en cours (${mode === 'code' ? 'Mode Code' : mode === 'story' ? 'Mode Conte' : 'Mode Recherche'})...`, 'info');
            aiResponseDiv.innerHTML = '...');
            aiResponseDiv.style.display = 'block';

            // 1. D√©terminer la cl√©, le prompt et la temp√©rature selon le mode
            let apiKey;
            let systemPrompt;
            let temperature = 0.7; 
            
            if (mode === 'code') {
                apiKey = GROQ_API_KEY_CODE;
                systemPrompt = `You are a specialized code generation assistant. Your response must be clean, use code blocks for any code output, and explain the code briefly. Answer in ${language}.`;
            } else if (mode === 'story') { 
                apiKey = GROQ_API_KEY_SEARCH; // Utilise la cl√© de recherche pour la cr√©ativit√©
                systemPrompt = `You are a creative and imaginative storyteller AI. You must write a captivating short story based on the user's request. Ensure the story is well-developed, engaging, and in ${language}. If the user mentions 'chat' or 'cat', the story must be about cats, kittens, or feline adventures.`;
                temperature = 0.9; 
            } else { // mode === 'search'
                apiKey = GROQ_API_KEY_SEARCH;
                systemPrompt = `You are a helpful and precise AI assistant called OmniSearch. You must answer the user's query in ${language}. Provide a detailed and well-structured response.`;
            }
            
            try {
                const response = await fetch(GROQ_API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}` 
                    },
                    body: JSON.stringify({
                        model: GROQ_MODEL,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: query }
                        ],
                        temperature: temperature 
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                const aiText = data.choices[0].message.content;

                displayStatusMessage(`R√©ponse de l'IA (${mode === 'code' ? 'Agent Code' : mode === 'story' ? 'Conte' : 'Recherche'}) :`, 'info');
                
                // CORRECTION: Utilisation de innerHTML pour g√©rer les sauts de ligne
                // Le style white-space: pre-wrap aide aussi √† l'affichage du code.
                aiResponseDiv.innerHTML = aiText.replace(/\n/g, '<br>'); 
                
                // En r√©alit√©, on ajouterait ici la requ√™te et la r√©ponse √† l'historique du chat actuel.
                queryInput.value = ''; // Effacer la saisie apr√®s l'envoi

            } catch (error) {
                console.error("Erreur de recherche IA:", error);
                displayStatusMessage(`Erreur de connexion √† l'IA: ${error.message}. V√©rifiez la console pour plus de d√©tails.`, 'error');
                aiResponseDiv.innerHTML = "Une erreur est survenue lors de la r√©cup√©ration de la r√©ponse.";
            }
        }
        
    </script>
</body>
</html>
