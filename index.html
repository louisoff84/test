<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniSearch AI - Moteur de Recherche</title>
    <link rel="stylesheet" href="css-public.css"> 
    
    <style>
        /* =========================================
           STYLES DU WIDGET DE CHAT FLOTTANT (Inclus pour la d√©monstration)
           ========================================= */
        :root {
            --primary: #1f2937;         
            --accent: #3b82f6;          
            --accent-hover: #2563eb;    
            --bg-light: #f9fafb;        
            --card-bg: #ffffff;         
            --text-muted: #6b7280;      
            --border-color: #e5e7eb;    
            --radius-md: 10px;          
            --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .chat-toggle-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 55px;
            height: 55px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.8em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: transform 0.2s, background-color 0.2s;
            line-height: 55px;
            text-align: center;
        }
        .chat-toggle-btn:hover {
            background-color: var(--accent-hover);
            transform: scale(1.05);
        }
        
        .chat-widget {
            position: fixed;
            bottom: 90px;
            right: 25px;
            width: 320px;
            height: 400px;
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-subtle);
            border: 1px solid var(--border-color);
            z-index: 999;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background-color: var(--primary);
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .chat-header .close-btn:hover { opacity: 1; }

        .chat-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: var(--bg-light);
            display: flex;
            flex-direction: column;
        }

        .chat-input-area {
            border-top: 1px solid var(--border-color);
            padding: 10px;
            display: flex;
            gap: 5px;
        }
        .chat-input-area input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            outline: none;
        }
        .chat-input-area button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-input-area button:hover {
            background-color: var(--accent-hover);
        }
        
        .message {
            max-width: 85%;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .user-message {
            background-color: var(--accent);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            background-color: white;
            color: var(--primary);
            border: 1px solid var(--border-color);
            margin-right: auto;
            border-top-left-radius: 4px;
        }

        @media (max-width: 600px) {
            .chat-widget {
                width: 90%;
                height: 70%;
                bottom: 10px;
                right: 5%;
                left: 5%;
            }
            .chat-toggle-btn {
                bottom: 10px;
                right: 10px;
            }
        }
        /* Style pour le s√©lecteur de mode */
        #mode-select {
            margin-right: 10px;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1em;
            color: var(--text-muted);
            background-color: var(--bg-light);
            cursor: pointer;
        }
        @media (max-width: 650px) {
             #mode-select {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
        /* Mise √† jour du style pour que le s√©lecteur de mode s'int√®gre bien dans la barre de recherche sur desktop */
        @media (min-width: 651px) {
            #mode-select {
                border: none;
                border-right: 1px solid var(--border-color);
                padding: 0 10px;
                background: transparent;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>

    <div class="overlay-screen" id="maintenance-overlay" style="display:none;">
        <span class="overlay-icon">üöß</span>
        <h2>Maintenance du Site</h2>
        <p>Le site OmniSearch est actuellement en maintenance pour des am√©liorations. Veuillez revenir plus tard.</p>
        <a href="login.html">Connexion Administrateur</a>
    </div>

    
    <header>
        <div id="user-info"></div>
        <a href="login.html" class="admin-link" id="admin-link">Connexion Admin</a>
    </header>

    <main id="main-content">
        <h1>OmniSearch AI</h1>
        <p class="subtitle">Votre moteur de recherche intelligent propuls√© par l'IA.</p>

        <div class="search-container">
             <select id="mode-select">
                <option value="search">üåç Mode Recherche</option>
                <option value="code">üíª Mode Agent Code</option>
                <option value="story">üìö Mode Conte d'Histoires</option>
            </select>
            <input type="text" id="query-input" placeholder="Posez votre question...">
            <select id="language-select">
                <option value="fr">Fran√ßais</option>
                <option value="en">English</option>
            </select>
            <button class="search-btn" onclick="performSearch()">Rechercher</button>
        </div>

        <div id="results-area">
            <div id="status-message" style="display:none;"></div>
            <div id="ai-response" class="ai-card" style="white-space: pre-wrap; display: none;"></div>
        </div>

    </main>
    
    <button class="chat-toggle-btn" id="chat-toggle-btn">üí¨</button>

    <div class="chat-widget" id="chat-widget">
        <div class="chat-header">
            <span>OmniChat AI</span>
            <button class="close-btn" onclick="toggleChat()">X</button>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="message ai-message">Bonjour ! Je suis OmniChat, l'assistant IA. Posez-moi une question !</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="√âcrivez votre message...">
            <button onclick="sendChatMessage()">Envoyer</button>
        </div>
    </div>
    
    
    <script>
        // ==========================================================
        //         CONFIGURATION ET CL√âS API GROQ
        // ==========================================================
        // ATTENTION: Ces cl√©s sont visibles dans le code source c√¥t√© client.
        // Pour la production, utilisez un proxy c√¥t√© serveur pour masquer les cl√©s.
        const GROQ_API_KEY_SEARCH = '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';
        const GROQ_API_KEY_CODE = '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';
        const GROQ_MODEL = 'llama-3.1-8b-instant';
        const GROQ_API_ENDPOINT = 'https://api.groq.com/openai/v1/chat/completions';

        // --- CONSTANTES DE STOCKAGE LOCAL ---
        const MAINTENANCE_SITE = 'siteMaintenance';
        const MAINTENANCE_IA = 'iaMaintenance';
        const BLOCKED_USERS = 'blockedUsers';
        const STORAGE_CURRENT_USER = 'currentUser';
        const STORAGE_IS_LOGGED_IN = 'isLoggedIn';

        // --- √âL√âMENTS DU DOM ---
        const queryInput = document.getElementById('query-input');
        const aiResponseDiv = document.getElementById('ai-response');
        const statusMessageDiv = document.getElementById('status-message');
        const searchButton = document.querySelector('.search-btn');
        const modeSelect = document.getElementById('mode-select');
        const chatWidget = document.getElementById('chat-widget');
        const chatBody = document.getElementById('chat-body');
        const chatInput = document.getElementById('chat-input');


        // ==========================================================
        //         LOGIQUE D'INITIALISATION ET DE S√âCURIT√â
        // ==========================================================

        document.addEventListener('DOMContentLoaded', () => {
            checkMaintenanceAndStatus();
            queryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            modeSelect.addEventListener('change', updatePlaceholder);
            updatePlaceholder(); // Appel initial
        });

        function updatePlaceholder() {
            const mode = modeSelect.value;
            if (mode === 'code') {
                queryInput.placeholder = "Entrez votre probl√®me de code ou la fonction √† g√©n√©rer...";
            } else if (mode === 'story') { 
                queryInput.placeholder = "D√©crivez le h√©ros, le lieu ou le type d'histoire que vous voulez...";
            } else {
                queryInput.placeholder = "Posez votre question...";
            }
        }
        
        function displayStatusMessage(message, type = 'info') {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = ''; 
            statusMessageDiv.classList.add('status-message');
            if (type === 'error') {
                statusMessageDiv.classList.add('error');
            }
            statusMessageDiv.style.display = 'block';
        }

        function checkMaintenanceAndStatus() {
            const siteMaintenance = localStorage.getItem(MAINTENANCE_SITE) === 'true';
            const iaMaintenance = localStorage.getItem(MAINTENANCE_IA) === 'true';
            const currentUser = localStorage.getItem(STORAGE_CURRENT_USER);
            const blockedUsers = JSON.parse(localStorage.getItem(BLOCKED_USERS) || '[]');
            
            // 1. Maintenance Totale
            if (siteMaintenance) {
                document.getElementById('maintenance-overlay').style.display = 'flex';
                return;
            }

            // 2. Utilisateur Bloqu√©
            if (currentUser && blockedUsers.includes(currentUser)) {
                document.getElementById('maintenance-overlay').style.display = 'flex';
                document.querySelector('.overlay-icon').textContent = 'üö´';
                document.querySelector('.overlay-screen h2').textContent = 'Acc√®s Refus√©';
                document.querySelector('.overlay-screen p').textContent = 'Votre compte a √©t√© bloqu√© par un administrateur.';
                document.getElementById('admin-link').style.display = 'none';
                return;
            }

            // 3. Maintenance IA
            if (iaMaintenance) {
                displayStatusMessage("L'IA est en maintenance. Seule la recherche classique fonctionne.", 'error');
                searchButton.disabled = true;
                queryInput.placeholder = "Recherche IA d√©sactiv√©e...";
                modeSelect.disabled = true;
                
                // D√©sactiver le chat
                document.getElementById('chat-input').disabled = true;
                document.getElementById('chat-input').placeholder = "Chat d√©sactiv√© (Maintenance IA)";
                document.querySelector('.chat-input-area button').disabled = true;
                if (chatWidget.style.display === 'flex') {
                     addMessage("L'assistant IA est temporairement en maintenance. Veuillez r√©essayer plus tard.", 'ai');
                }
                
            } else {
                searchButton.disabled = false;
                modeSelect.disabled = false;
                updatePlaceholder();
            }
            
            // Afficher l'√©tat de connexion
            const userInfoDiv = document.getElementById('user-info');
            if (currentUser) {
                userInfoDiv.innerHTML = `Connect√© comme : <strong>${currentUser}</strong>`;
                document.getElementById('admin-link').textContent = "D√©connexion";
                document.getElementById('admin-link').href = "#";
                document.getElementById('admin-link').onclick = logout;
            } else {
                 userInfoDiv.innerHTML = `Invit√©`;
                 document.getElementById('admin-link').textContent = "Connexion Admin";
                 document.getElementById('admin-link').href = "login.html";
                 document.getElementById('admin-link').onclick = null;
            }
        }
        
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentUserType');
            window.location.href = 'login.html';
        }

        // ==========================================================
        //         FONCTIONS DE RECHERCHE PRINCIPALE (IA)
        // ==========================================================

        async function performSearch() {
            const query = queryInput.value.trim();
            const language = document.getElementById('language-select').value;
            const mode = modeSelect.value; 
            
            if (!query) {
                displayStatusMessage("Veuillez entrer une requ√™te.", 'error');
                aiResponseDiv.style.display = 'none';
                return;
            }

            if (localStorage.getItem(MAINTENANCE_IA) === 'true') {
                 displayStatusMessage("Recherche impossible : L'IA est en maintenance.", 'error');
                 return;
            }
            
            displayStatusMessage(`Recherche en cours (${mode === 'code' ? 'Mode Code' : mode === 'story' ? 'Mode Conte' : 'Mode Recherche'})...`, 'info');
            aiResponseDiv.style.display = 'none';

            // 1. D√©terminer la cl√© et le prompt selon le mode
            let apiKey;
            let systemPrompt;
            let temperature = 0.7; // Temp√©rature par d√©faut
            
            if (mode === 'code') {
                apiKey = GROQ_API_KEY_CODE;
                systemPrompt = `You are a specialized code generation assistant. Your response must be clean, use code blocks for any code output, and explain the code briefly. Answer in ${language}.`;
            } else if (mode === 'story') { 
                apiKey = GROQ_API_KEY_SEARCH; 
                systemPrompt = `You are a creative and imaginative storyteller AI. You must write a captivating short story based on the user's request. Ensure the story is well-developed, engaging, and in ${language}. If the user mentions 'chat' or 'cat', the story must be about cats, kittens, or feline adventures.`;
                temperature = 0.9; // Plus cr√©atif
            } else { // mode === 'search'
                apiKey = GROQ_API_KEY_SEARCH;
                systemPrompt = `You are a helpful and precise AI assistant called OmniSearch. You must answer the user's query in ${language}. Provide a detailed and well-structured response.`;
            }
            
            try {
                const response = await fetch(GROQ_API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}` 
                    },
                    body: JSON.stringify({
                        model: GROQ_MODEL,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: query }
                        ],
                        temperature: temperature 
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                const aiText = data.choices[0].message.content;

                displayStatusMessage(`R√©ponse de l'IA (${mode === 'code' ? 'Agent Code' : mode === 'story' ? 'Conte' : 'Recherche'}) :`, 'info');
                aiResponseDiv.textContent = aiText;
                aiResponseDiv.style.display = 'block';

            } catch (error) {
                console.error("Erreur de recherche IA:", error);
                displayStatusMessage(`Erreur de connexion √† l'IA: ${error.message}. V√©rifiez la console pour plus de d√©tails.`, 'error');
                aiResponseDiv.style.display = 'none';
            }
        }


        // ==========================================================
        //         FONCTIONS DU WIDGET DE CHAT (IA)
        // ==========================================================
        // Le chat est un assistant g√©n√©ral et utilise la cl√© de recherche.

        document.getElementById('chat-toggle-btn').addEventListener('click', toggleChat);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        function toggleChat() {
            chatWidget.style.display = chatWidget.style.display === 'flex' ? 'none' : 'flex';
            if (chatWidget.style.display === 'flex') {
                chatInput.focus();
            }
        }
        
        function addMessage(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            msgDiv.textContent = text;
            chatBody.appendChild(msgDiv);
            
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function sendChatMessage() {
            const userText = chatInput.value.trim();
            if (userText === '') return;
            
            if (localStorage.getItem(MAINTENANCE_IA) === 'true') {
                 addMessage("L'assistant est en maintenance et ne peut pas r√©pondre.", 'ai');
                 chatInput.value = '';
                 return;
            }

            addMessage(userText, 'user');
            chatInput.value = '';

            addMessage('...', 'ai');
            const typingMsg = chatBody.lastElementChild;

            const chatSystemPrompt = "You are a quick, friendly, and informal chat assistant. Answer briefly in French.";
            const apiKey = GROQ_API_KEY_SEARCH; 

            try {
                const response = await fetch(GROQ_API_ENDPOINT, {
                    method: 'POST',
                    head