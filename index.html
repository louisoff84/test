<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniSearch AI - Moteur de Recherche</title>
    <link rel="stylesheet" href="css-public.css"> 
</head>
<body>

    <div id="blocked-screen" class="overlay-screen" style="display: none;">
        <div class="overlay-icon">‚õî</div>
        <h2>Acc√®s Refus√©</h2>
        <p>Votre compte a √©t√© bloqu√© par un administrateur. Contactez le support pour plus d'informations.</p>
        <br>
        <a href="#" onclick="logout()" style="color:#4285f4;">Se D√©connecter</a>
    </div>

    <div id="maintenance-screen" class="overlay-screen" style="display: none;">
        <div class="overlay-icon">üöß</div>
        <h2>Site en Maintenance</h2>
        <p>Nous effectuons actuellement des mises √† jour importantes. Le service sera de retour tr√®s bient√¥t.</p>
        <br>
        <a href="login.html" style="color:#4285f4;">Acc√®s Admin</a>
    </div>

    <div id="main-content">
        <header style="display: flex; justify-content: flex-end; padding-top: 15px; padding-right: 15px;">
            <span id="user-info" style="margin-right: 20px;"></span>
            <a href="shop.html" class="admin-link" style="margin-right: 20px;">üéÅ Boutique & Giveaways</a>
            <a href="login.html" class="admin-link" id="login-link">Connexion</a> 
        </header>

        <main>
            <h1>OmniSearch AI üß†</h1>
            <p class="subtitle">Explorez les livres, les films et le savoir mondial gr√¢ce √† l'IA.</p>

            <nav class="mode-nav">
                <a href="index.html" style="background-color: #3498db; color: white;">Mode Standard</a>
                <a href="pro_mode.html">Mode Pro üíº</a>
                <a href="agent_mode.html">Mode Agent üïµÔ∏è</a>
                <a href="hosting_mode.html">Mode H√©bergement üåê</a> 
            </nav>

            <div class="search-container">
                <input type="text" id="query-input" placeholder="Posez votre question...">
                
                <select id="language-select">
                    <option value="fr" selected>FR</option>
                    <option value="en">EN</option>
                    <option value="es">ES</option>
                </select>

                <button class="search-btn" onclick="performGroqSearch()">Rechercher</button>
            </div>

            <div id="status-message" style="display: none; margin-top: 15px;"></div>

            <div id="results-area" style="display: none;">
                <div id="loading-indicator" class="loading" style="display: none;">
                    L'IA r√©fl√©chit et r√©dige votre r√©ponse... ü§ñ
                </div>
                <div id="ai-response" class="ai-card" style="display: none;">
                    </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        const GROQ_API_KEY = "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"; 
        const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
        const GROQ_MODEL = "llama-3.1-8b-instant"; 
        
        const STORAGE_MAINTENANCE_SITE = 'siteMaintenance';
        const STORAGE_MAINTENANCE_IA = 'iaMaintenance';
        const STORAGE_BLOCKED_USERS = 'blockedUsers';
        const STORAGE_CURRENT_USER = 'currentUser';
        const STORAGE_IS_LOGGED_IN = 'isLoggedIn';

        // ============================================
        // 1. V√âRIFICATION D'ACC√àS ET STATUT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            checkSystemStatus();
            updateLoginUI();
            
            document.getElementById('query-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performGroqSearch();
                }
            });
        });

        function updateLoginUI() {
            const isLoggedIn = localStorage.getItem(STORAGE_IS_LOGGED_IN) === 'true';
            const currentUser = localStorage.getItem(STORAGE_CURRENT_USER);
            const loginLink = document.getElementById('login-link');
            const userInfo = document.getElementById('user-info');
            
            if (isLoggedIn) {
                loginLink.textContent = "D√©connexion";
                loginLink.onclick = logout;
                loginLink.href = "#"; 
                userInfo.textContent = `Connect√©: ${currentUser} |`;
            } else {
                loginLink.textContent = "Connexion";
                loginLink.href = "login.html";
                loginLink.onclick = null;
                userInfo.textContent = "";
            }
        }

        function logout() {
            localStorage.removeItem(STORAGE_IS_LOGGED_IN);
            localStorage.removeItem(STORAGE_CURRENT_USER);
            localStorage.removeItem('currentUserType'); 
            window.location.href = 'index.html'; 
        }

        function checkSystemStatus() {
            const currentUser = localStorage.getItem(STORAGE_CURRENT_USER) || 'anonyme'; 
            const siteMaint = localStorage.getItem(STORAGE_MAINTENANCE_SITE) === 'true';
            const blockedUsers = JSON.parse(localStorage.getItem(STORAGE_BLOCKED_USERS) || '[]');
            
            const mainContent = document.getElementById('main-content');
            
            if (siteMaint) {
                document.getElementById('maintenance-screen').style.display = 'flex';
                mainContent.style.display = 'none';
                return; 
            }
            
            if (blockedUsers.includes(currentUser)) {
                document.getElementById('blocked-screen').style.display = 'flex';
                mainContent.style.display = 'none';
                return;
            }

            mainContent.style.display = 'block';
        }

        // ============================================
        // 2. FONCTION DE RECHERCHE (GROQ API)
        // ============================================
        async function performGroqSearch() {
            const queryInput = document.getElementById('query-input');
            const query = queryInput.value.trim();
            const lang = document.getElementById('language-select').value;
            const resultsArea = document.getElementById('results-area');
            const loading = document.getElementById('loading-indicator');
            const responseDiv = document.getElementById('ai-response');
            const statusMsg = document.getElementById('status-message');

            statusMsg.style.display = 'none';
            responseDiv.style.display = 'none';
            responseDiv.textContent = '';
            
            if (!query) {
                alert("Veuillez √©crire quelque chose !");
                return;
            }

            const iaMaint = localStorage.getItem(STORAGE_MAINTENANCE_IA) === 'true';
            if (iaMaint) {
                statusMsg.textContent = "‚ö†Ô∏è La recherche IA est temporairement en maintenance. Revenez plus tard.";
                statusMsg.className = "error";
                statusMsg.style.display = 'block';
                return;
            }

            if (GROQ_API_KEY === "VOTRE_CLE_API_GROQ_ICI" || !GROQ_API_KEY) {
                statusMsg.textContent = "Erreur Configuration : Cl√© API manquante. Veuillez ins√©rer votre cl√© Groq.";
                statusMsg.className = "error";
                statusMsg.style.display = 'block';
                return;
            }

            resultsArea.style.display = 'block';
            loading.style.display = 'block';

            const systemPrompt = `Tu es un assistant expert en livres, films, culture et savoir g√©n√©ral. 
            R√©ponds √† la question de mani√®re structur√©e, claire et utile. 
            R√©ponds obligatoirement dans la langue : ${lang}.
            Si la question porte sur un livre, donne le titre, l'auteur, l'ann√©e et un r√©sum√©.`;

            try {
                const response = await fetch(GROQ_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: GROQ_MODEL, 
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: query }
                        ],
                        temperature: 0.7,
                        max_tokens: 1024
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const aiText = data.choices[0].message.content;
                loading.style.display = 'none';
                responseDiv.style.display = 'block';
                responseDiv.textContent = aiText;

            } catch (error) {
                loading.style.display = 'none';
                statusMsg.textContent = `Erreur IA : ${error.message}. V√©rifiez la cl√© API ou le nom du mod√®le Groq.`;
                statusMsg.className = "error";
                statusMsg.style.display = 'block';
                console.error(error);
            }
        }
    </script>
</body>
</html>
