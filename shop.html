<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique & Giveaways - OmniSearch</title>
    <link rel="stylesheet" href="css-public.css"> 
    <style>
        .shop-container {
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .giveaway-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .giveaway-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--accent-color);
        }
        .giveaway-card h3 {
            color: var(--accent-color);
            margin-top: 0;
        }
        .giveaway-card p {
            font-size: 0.9em;
            color: var(--primary-text);
            margin-bottom: 15px;
        }
        .giveaway-card button {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .giveaway-card button:hover {
            background-color: #27ae60;
        }
        .giveaway-card button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <header>
        <nav style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #34495e; color: white;">
            <a href="index.html" style="color: white; text-decoration: none;">‚Üê Accueil</a>
            <span id="user-info-shop" style="margin-right: 20px;"></span>
            <a href="#" id="auth-link" style="color: white; text-decoration: none;">Connexion</a>
        </nav>
    </header>

    <div class="shop-container">
        <h2>üéâ Nos Giveaways Actuels</h2>
        <p style="margin-bottom: 30px;">Inscrivez-vous pour avoir une chance de gagner un de nos prix ! (Seuls les utilisateurs connect√©s peuvent participer).</p>

        <div id="giveaway-list" class="giveaway-list">
            <p id="no-ga-msg">Chargement des giveaways...</p>
        </div>
    </div>

    <script>
        const GIVEAWAYS_KEY = 'GIVEAWAYS_DB';
        const STORAGE_CURRENT_USER = 'currentUser';
        const STORAGE_IS_LOGGED_IN = 'isLoggedIn';

        document.addEventListener('DOMContentLoaded', () => {
            updateUI();
            renderGiveaways();
        });

        function updateUI() {
            const isLoggedIn = localStorage.getItem(STORAGE_IS_LOGGED_IN) === 'true';
            const currentUser = localStorage.getItem(STORAGE_CURRENT_USER);
            const authLink = document.getElementById('auth-link');
            const userInfo = document.getElementById('user-info-shop');

            if (isLoggedIn) {
                authLink.textContent = "D√©connexion";
                authLink.href = "#";
                authLink.onclick = logout;
                userInfo.textContent = `Connect√©: ${currentUser}`;
            } else {
                authLink.textContent = "Connexion";
                authLink.href = "login.html";
                authLink.onclick = null;
                userInfo.textContent = "Visiteur";
            }
        }

        function logout() {
            localStorage.removeItem(STORAGE_IS_LOGGED_IN);
            localStorage.removeItem(STORAGE_CURRENT_USER);
            localStorage.removeItem('currentUserType');
            window.location.href = 'shop.html';
        }

        function getGiveaways() {
            return JSON.parse(localStorage.getItem(GIVEAWAYS_KEY) || '[]');
        }
        
        function saveGiveaways(giveaways) {
            localStorage.setItem(GIVEAWAYS_KEY, JSON.stringify(giveaways));
        }

        function renderGiveaways() {
            const giveaways = getGiveaways();
            const listContainer = document.getElementById('giveaway-list');
            const isLoggedIn = localStorage.getItem(STORAGE_IS_LOGGED_IN) === 'true';
            const currentUser = localStorage.getItem(STORAGE_CURRENT_USER);
            listContainer.innerHTML = '';
            
            const activeGiveaways = giveaways.filter(ga => ga.active);

            if (activeGiveaways.length === 0) {
                listContainer.innerHTML = '<p id="no-ga-msg" style="text-align: center; grid-column: 1 / -1; color: #7f8c8d;">Aucun giveaway actif pour le moment. Revenez bient√¥t !</p>';
                return;
            }

            activeGiveaways.forEach(ga => {
                const alreadyJoined = ga.participants.includes(currentUser);
                const buttonText = alreadyJoined ? 'Inscrit ‚úÖ' : 'Participer';
                const isDisabled = !isLoggedIn || alreadyJoined;
                const tooltip = !isLoggedIn ? 'Veuillez vous connecter pour participer.' : '';

                const card = document.createElement('div');
                card.className = 'giveaway-card';
                card.innerHTML = `
                    <h3>${ga.name}</h3>
                    <p>${ga.description}</p>
                    <p>Participants: <strong>${ga.participants.length}</strong></p>
                    <button 
                        data-id="${ga.id}" 
                        onclick="joinGiveaway(${ga.id}, this)"
                        ${isDisabled ? 'disabled' : ''}
                        title="${tooltip}"
                    >
                        ${buttonText}
                    </button>
                `;
                listContainer.appendChild(card);
            });
        }

        function joinGiveaway(id, buttonElement) {
            const giveaways = getGiveaways();
            const currentUser = localStorage.getItem(STORAGE_CURRENT_USER);
            const ga = giveaways.find(g => g.id === id);

            if (!ga) return alert("Erreur: Giveaway non trouv√©.");

            if (!ga.participants.includes(currentUser)) {
                ga.participants.push(currentUser);
                saveGiveaways(giveaways);

                alert(`Inscription r√©ussie au giveaway "${ga.name}" ! Bonne chance.`);
                
                buttonElement.textContent = 'Inscrit ‚úÖ';
                buttonElement.disabled = true;
                
                renderGiveaways(); 
            }
        }
    </script>
</body>
</html>
