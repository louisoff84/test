<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - OmniSearch</title>
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>

    <aside class="sidebar">
        <div class="brand">
            <h3>‚öôÔ∏è OmniAdmin</h3>
        </div>
        <nav>
            <ul>
                <li class="active"><a href="admin.html">Tableau de Bord</a></li> 
                <li><a href="account_management.html">Gestion des Comptes</a></li>
                <li><a href="shop_admin.html">Gestion des Giveaways</a></li> 
                <li><a href="#" onclick="alert('Page Analytiques en cours de d√©veloppement !')" style="opacity:0.9;">Analytiques (Simul√©)</a></li>
            </ul>
        </nav>
        <div class="logout-area">
            <button onclick="logout()" class="btn-logout">D√©connexion</button>
        </div>
    </aside>

    <main class="main-content">
        <header>
            <h1>Vue d'ensemble et Contr√¥le</h1>
            <a href="index.html" target="_blank" class="view-site-link">Voir le site public ‚Üó</a>
        </header>

        <div class="dashboard-grid">
            
            <div class="card analytics-card">
                <div class="card-header">
                    <h2>üìà Statistiques Cl√©s</h2>
                </div>
                <div class="card-body">
                    <p><strong>Comptes Totaux :</strong> <span id="total-users">0</span></p>
                    <p><strong>Utilisateurs Actifs :</strong> <span id="active-users">0</span></p>
                    <hr style="margin: 10px 0;">
                    <p><strong>Requ√™tes IA Aujourd'hui :</strong> <span id="ia-requests">0</span></p>
                    <p><strong>Statut Cl√© API :</strong> <span style="color: var(--success-color); font-weight: bold;">Connect√©e</span></p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>üö¶ Contr√¥le de Maintenance</h2>
                </div>
                <div class="card-body">
                    
                    <div class="toggle-item">
                        <div class="toggle-info">
                            <strong>Maintenance Globale</strong>
                            <p>Ferme l'acc√®s complet au site (Affiche l'√©cran üöß).</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="site-maintenance-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    
                    <hr>

                    <div class="toggle-item">
                        <div class="toggle-info">
                            <strong>Maintenance IA</strong>
                            <p>D√©sactive uniquement la fonction de recherche (API Groq).</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="ia-maintenance-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>üë• Gestion Rapide des Comptes</h2>
                </div>
                <div class="card-body">
                    <p>Utilisez l'outil ci-dessous pour bloquer ou d√©bloquer un utilisateur rapidement.</p>
                    
                    <div class="input-group" style="margin-bottom: 20px;">
                        <input type="text" id="block-input" placeholder="Pseudo √† bloquer ou d√©bloquer">
                        <button onclick="blockUser()" class="btn-secondary">Bloquer</button>
                    </div>
                    
                    <p><strong>Total d'utilisateurs bloqu√©s :</strong> <span id="blocked-count">0</span></p>
                    
                    <a href="account_management.html" class="btn-text" style="display: block; margin-top: 10px;">Acc√©der √† la Gestion Compl√®te des Comptes ‚Üí</a>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- V√âRIFICATION DE S√âCURIT√â ET CONSTANTES ---
        if (localStorage.getItem('isLoggedIn') !== 'true' || localStorage.getItem('currentUserType') !== 'admin') {
            window.location.href = 'login.html'; 
        }

        const STORAGE_MAINTENANCE_SITE = 'siteMaintenance';
        const STORAGE_MAINTENANCE_IA = 'iaMaintenance';
        const STORAGE_BLOCKED_USERS = 'blockedUsers';
        const STORAGE_USERS_DB = 'REGULAR_USERS'; 
        const ADMIN_USER = "admin";

        // 1. CHARGEMENT AU D√âMARRAGE
        document.addEventListener('DOMContentLoaded', () => {
            loadMaintenanceStatus();
            loadAndRenderStats();
            
            document.getElementById('site-maintenance-toggle').addEventListener('change', saveMaintenanceStatus);
            document.getElementById('ia-maintenance-toggle').addEventListener('change', saveMaintenanceStatus);
        });
        
        // 2. FONCTIONS DE MAINTENANCE
        function loadMaintenanceStatus() {
            const siteMaint = localStorage.getItem(STORAGE_MAINTENANCE_SITE) === 'true';
            const iaMaint = localStorage.getItem(STORAGE_MAINTENANCE_IA) === 'true';

            document.getElementById('site-maintenance-toggle').checked = siteMaint;
            document.getElementById('ia-maintenance-toggle').checked = iaMaint;
        }

        function saveMaintenanceStatus() {
            const siteMaint = document.getElementById('site-maintenance-toggle').checked;
            const iaMaint = document.getElementById('ia-maintenance-toggle').checked;

            localStorage.setItem(STORAGE_MAINTENANCE_SITE, siteMaint);
            localStorage.setItem(STORAGE_MAINTENANCE_IA, iaMaint);
        }

        // 3. FONCTIONS D'ANALYTIQUES ET STATS
        function loadAndRenderStats() {
            const usersDB = JSON.parse(localStorage.getItem(STORAGE_USERS_DB) || '[]');
            const blockedUsers = JSON.parse(localStorage.getItem(STORAGE_BLOCKED_USERS) || '[]');
            
            const totalUsers = usersDB.length + 1; // +1 pour l'admin
            const activeUsers = usersDB.filter(u => !blockedUsers.includes(u.user)).length + 1; 

            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('active-users').textContent = activeUsers;
            document.getElementById('blocked-count').textContent = blockedUsers.length;
            
            document.getElementById('ia-requests').textContent = Math.floor(Math.random() * 500 + 300);
        }


        // 4. FONCTIONS DE GESTION UTILISATEURS (Raccourci Bloquer)
        function blockUser() {
            const input = document.getElementById('block-input');
            const pseudo = input.value.trim();

            if (!pseudo) return alert("Veuillez entrer un pseudo.");
            if (pseudo === ADMIN_USER) return alert("L'administrateur ne peut pas √™tre bloqu√© ici.");

            let blockedList = JSON.parse(localStorage.getItem(STORAGE_BLOCKED_USERS) || '[]');
            let usersDB = JSON.parse(localStorage.getItem(STORAGE_USERS_DB) || '[]');
            const userExists = usersDB.some(u => u.user === pseudo);

            if (!userExists) return alert("Erreur : Utilisateur non trouv√© dans la base de donn√©es.");

            if (blockedList.includes(pseudo)) {
                // D√©bloquer
                blockedList = blockedList.filter(u => u !== pseudo);
                alert(`Utilisateur '${pseudo}' D√âBLOQU√â.`);
            } else {
                // Bloquer
                blockedList.push(pseudo);
                alert(`Utilisateur '${pseudo}' BLOQU√â et ajout√© √† la liste noire.`);
            }

            localStorage.setItem(STORAGE_BLOCKED_USERS, JSON.stringify(blockedList));
            
            input.value = '';
            loadAndRenderStats(); // Mettre √† jour le compteur
        }
        
        // 5. D√âCONNEXION
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUserType');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
